apiVersion: batch/v1
kind: Job
metadata:
  name: dlrm-preprocess-job
spec:
  # Run 8 pods in parallel to speed up processing
  parallelism: 8
  completions: 8
  backoffLimit: 0
  template:
    # --- The metadata block with the Fuse annotation is here ---
    metadata:
      annotations:
        gke-gcsfuse/volumes: "true"
    spec:
      serviceAccountName: tpu-training-sa
      restartPolicy: Never
      volumes:
      - name: gcs-fuse-csi-volume
        csi:
          driver: gcsfuse.csi.storage.gke.io
          volumeAttributes:
            bucketName: ${BUCKET_NAME} # This will be replaced by the script
            mountOptions: "implicit-dirs"
      containers:
      - name: preprocess-worker
        image: ${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO_NAME}/dlrm-preprocess:latest
        imagePullPolicy: Always
        volumeMounts:
        - name: gcs-fuse-csi-volume
          mountPath: /gcs
        env:
        # These are passed to the python script to coordinate work
        - name: PARALLELISM
          value: "8" # Must match spec.parallelism
        - name: JOB_COMPLETION_INDEX
          valueFrom:
            fieldRef:
              # This field provides the unique index (0 to 7) for each pod
              fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']

